---
title: "R Notebook"
output: html_notebook
---

```{r}
library('dplyr')
library('jsonlite')
library('readr')

data <- read.csv('Project 3 Prelim Data2 (3)/6a9f52d0-528d-4670-b162-85ebf902f4f3_Data.csv')
View(data)

meta<- read.csv('Project 3 Prelim Data2 (1)/718a0a51-7e31-4851-bce7-4403cc3e4913_Country - Metadata.csv')
View(meta)
```

```{r}
# get region
merged <- merge(data, meta, by.x = 'Country.Code', by.y = 'Code')
merged <- merged[merged$Region == 'Sub-Saharan Africa',]
summary(merged)
View(merged)

country_data <- merged %>%
  select(Country.Name, Country.Code, Time, Agricultural.irrigated.land....of.total.agricultural.land...AG.LND.IRIG.AG.ZS., Agricultural.machinery..tractors..AG.AGR.TRAC.NO., Agricultural.machinery..tractors.per.100.sq..km.of.arable.land..AG.LND.TRAC.ZS., Agriculture.value.added.per.worker..constant.2010.US....EA.PRD.AGRI.KD., Agricultural.land....of.land.area...AG.LND.AGRI.ZS., Agriculture..value.added..annual...growth...NV.AGR.TOTL.KD.ZG., Depth.of.the.food.deficit..kilocalories.per.person.per.day...SN.ITK.DFCT., Food.exports....of.merchandise.exports...TX.VAL.FOOD.ZS.UN., Food.imports....of.merchandise.imports...TM.VAL.FOOD.ZS.UN., Fertilizer.consumption....of.fertilizer.production...AG.CON.FERT.PT.ZS., Fertilizer.consumption..kilograms.per.hectare.of.arable.land...AG.CON.FERT.ZS., Rural.poverty.gap.at.national.poverty.lines......SI.POV.RUGP., Employment.in.agriculture....of.total.employment...SL.AGR.EMPL.ZS., Rural.population....of.total.population...SP.RUR.TOTL.ZS.,
Industry..value.added....of.GDP...NV.IND.TOTL.ZS.,
Industry..value.added..annual...growth...NV.IND.TOTL.KD.ZG.
) %>%
  rename(AgriValuePerWorker = Agriculture.value.added.per.worker..constant.2010.US....EA.PRD.AGRI.KD.,
        RuralPovGap = Rural.poverty.gap.at.national.poverty.lines......SI.POV.RUGP., 
        RuralPopPerc = Rural.population....of.total.population...SP.RUR.TOTL.ZS.,
        FoodDeficit = Depth.of.the.food.deficit..kilocalories.per.person.per.day...SN.ITK.DFCT.,
        IrrigatedLandPerc = Agricultural.irrigated.land....of.total.agricultural.land...AG.LND.IRIG.AG.ZS.,
        TractorsNum = Agricultural.machinery..tractors..AG.AGR.TRAC.NO.,
        TractorsRel = Agricultural.machinery..tractors.per.100.sq..km.of.arable.land..AG.LND.TRAC.ZS.,
        FoodExportsP = Food.exports....of.merchandise.exports...TX.VAL.FOOD.ZS.UN.,
        FoodImportsP = Food.imports....of.merchandise.imports...TM.VAL.FOOD.ZS.UN., 
        FertilizerConsump = Fertilizer.consumption....of.fertilizer.production...AG.CON.FERT.PT.ZS., 
        FertilizerConsumpPerHA = Fertilizer.consumption..kilograms.per.hectare.of.arable.land...AG.CON.FERT.ZS.,
        EmployInAg = Employment.in.agriculture....of.total.employment...SL.AGR.EMPL.ZS.,
        IndustryAddedValPercGDP = Industry..value.added....of.GDP...NV.IND.TOTL.ZS.,
        IndustryPecGrowth = Industry..value.added..annual...growth...NV.IND.TOTL.KD.ZG.,
        Country = Country.Name)
#TODO: add more variabel aliases

View(country_data)
```

# Top Crops per Country
```{r}
options(scipen=999)
crops <- read.csv('CpC2.csv')
# summary(crops)
crops <- crops[order(crops$Area, crops$Year, -crops$Value),]
View(crops)
# grouped_crops <- group_by(crops, crops$Area, crops$Year)

# gets the total number of crops for each country/year
grouped_summary <- crops %>%
  group_by(Area, Year) %>%
  summarise(totalValue = sum(Value, na.rm= TRUE))

# add total column to full data
merged_crops <- left_join(crops, grouped_summary, by= c("Area", "Year"))

# calculate % of total
merged_crops$percentOfTotal<- merged_crops$Value/merged_crops$totalValue

# View(grouped_summary)
# View(merged_crops)

top_crops <- merged_crops %>%
  group_by(Area, Year) %>%
  filter(row_number() ==1) %>%
  select(Area, Year, Unit, Value, Item, totalValue, percentOfTotal)

View(top_crops)

```

blending both datasources together
```{r}
final_data <- left_join(country_data, top_crops, by= c ("Country.Name" = "Area", "Time" = "Year"))

final_data <- final_data %>% 
  filter(Time >= 2004) %>%
  toJSON() %>%
  write_lines('agdata.json')


View(final_data)

```


